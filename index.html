<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5.dev">
<meta name="author" content="Máster en Tecnologías y Aplicaciones en Ingeniería Informática">
<title>API REST para la pila MEAN (JWT y Swagger incluido)</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-right">
<div id="header">
<h1>API REST para la pila MEAN (JWT y Swagger incluido)</h1>
<div class="details">
<span id="author" class="author">Máster en Tecnologías y Aplicaciones en Ingeniería Informática</span><br>
<span id="revdate">UAL</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Tabla de contenidos</div>
<ul class="sectlevel1">
<li><a href="#trueresumen">Resumen</a></li>
<li><a href="#trueconfiguraci-n-del-entorno-para-ubuntu-linux">1. Configuración del entorno para Ubuntu Linux</a></li>
<li><a href="#truepreparaci-n-del-proyecto">2. Preparación del proyecto</a>
<ul class="sectlevel2">
<li><a href="#truecreaci-n-del-proyecto">2.1. Creación del proyecto</a></li>
<li><a href="#trueestructura-predeterminada-del-proyecto">2.2. Estructura predeterminada del proyecto</a></li>
<li><a href="#trueconfiguraci-n-de-carpetas">2.3. Configuración de carpetas</a></li>
<li><a href="#trueinicializar-la-base-de-datos">2.4. Inicializar la base de datos</a></li>
<li><a href="#trueconexi-n-y-l-gica-de-conexi-n-desconexi-n">2.5. Conexión y lógica de conexión/desconexión</a></li>
<li><a href="#trueincluir-el-archivo-code-db-js-code-en-code-app-js-code">2.6. Incluir el archivo <code>db.js</code> en <code>app.js</code></a></li>
</ul>
</li>
<li><a href="#truecreaci-n-del-primer-endpoint">3. Creación del primer endpoint</a>
<ul class="sectlevel2">
<li><a href="#truecreaci-n-del-modelo">3.1. Creación del modelo</a></li>
<li><a href="#truecreaci-n-de-un-controlador-b-sico">3.2. Creación de un controlador básico</a></li>
<li><a href="#truecreaci-n-de-la-ruta">3.3. Creación de la ruta</a></li>
<li><a href="#trueincoporaci-n-del-archivo-de-rutas-en-code-app-js-code">3.4. Incoporación del archivo de rutas en <code>app.js</code></a></li>
</ul>
</li>
<li><a href="#truecreaci-n-de-otros-endpoints-de-consulta-get">4. Creación de otros endpoints de consulta (GET)</a>
<ul class="sectlevel2">
<li><a href="#trueobtener-libros-por-id">4.1. Obtener libros por ID</a></li>
<li><a href="#trueobtener-libros-por-g-nero">4.2. Obtener libros por género</a></li>
</ul>
</li>
<li><a href="#truelas-otras-operaciones-crud">5. Las otras operaciones CRUD</a>
<ul class="sectlevel2">
<li><a href="#truecreaci-n-de-documentos-post">5.1. Creación de documentos (POST)</a></li>
<li><a href="#trueeliminaci-n-de-documentos-delete">5.2. Eliminación de documentos (DELETE)</a></li>
<li><a href="#trueactualizaci-n-de-documentos-put">5.3. Actualización de documentos (PUT)</a></li>
</ul>
</li>
<li><a href="#trueconsumir-de-la-api-rest">6. Consumir de la API REST</a>
<ul class="sectlevel2">
<li><a href="#truecreaci-n-del-controlador-5">6.1. Creación del controlador</a></li>
<li><a href="#truecreaci-n-de-la-ruta-7">6.2. Creación de la ruta</a></li>
<li><a href="#truecreaci-n-de-la-vista">6.3. Creación de la vista</a></li>
<li><a href="#truemodificaci-n-del-archivo-code-app-js-code">6.4. Modificación del archivo <code>app.js</code></a></li>
</ul>
</li>
<li><a href="#trueacceso-a-la-api-mediante-json-web-tokens-jwt">7. Acceso a la API mediante JSON Web Tokens (JWT)</a>
<ul class="sectlevel2">
<li><a href="#truejwt">7.1. JWT</a></li>
<li><a href="#trueincorporaci-n-de-jwt-a-la-api-rest">7.2. Incorporación de JWT a la API REST</a></li>
<li><a href="#trueuso-de-la-api-mediante-autenticaci-n">7.3. Uso de la API mediante autenticación</a></li>
</ul>
</li>
<li><a href="#truedocumentaci-n-de-la-api-mediante-swagger">8. Documentación de la API mediante Swagger</a>
<ul class="sectlevel2">
<li><a href="#truepartes-b-sicas-de-la-documentaci-n-swagger">8.1. Partes básicas de la documentación Swagger</a></li>
<li><a href="#truedocumentaci-n-swagger-de-la-api-fragmento">8.2. Documentación Swagger de la API (fragmento)</a></li>
<li><a href="#trueincorporar-la-documentaci-n-de-la-api-al-proyecto">8.3. Incorporar la documentación de la API al proyecto</a></li>
<li><a href="#trueimportaci-n-de-la-documentaci-n-como-una-ruta-del-proyecto">8.4. Importación de la documentación como una ruta del proyecto</a></li>
</ul>
</li>
<li><a href="#trueconclusiones">9. Conclusiones</a></li>
<li><a href="#trueap-ndice-a-c-digos-de-estado-http-frecuentes">Apéndice A. Códigos de estado HTTP frecuentes</a></li>
<li><a href="#trueap-ndice-b-base-de-datos-de-ejemplo">Apéndice B. Base de datos de ejemplo</a></li>
<li><a href="#trueap-ndice-c-aplicaci-n-base-creada-por-express">Apéndice C. Aplicación base creada por Express</a>
<ul class="sectlevel2">
<li><a href="#trueel-archivo-code-app-js-code">El archivo <code>app.js</code></a></li>
<li><a href="#truelas-vistas-iniciales">Las vistas iniciales</a></li>
<li><a href="#truela-ruta-y-el-controlador-inicial">La ruta y el controlador inicial</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Manuel Torres - Departamento de Informática. UAL</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/di.png" alt="di.png">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueresumen"><a class="anchor" href="#trueresumen"></a>Resumen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Veremos los pasos básicos para el desarrollo de una API REST para la pila MEAN.</p>
</div>
<div class="ulist">
<div class="title">Objetivos</div>
<ul>
<li>
<p>Configurar el entorno</p>
</li>
<li>
<p>Crear la estructura organizada de carpetas y archivos de un proyecto MEAN</p>
</li>
<li>
<p>Conocer el funcionamiento básico de rutas, controladores y modelos</p>
</li>
<li>
<p>Realizar las operaciones CRUD básicas</p>
</li>
<li>
<p>Aprender a consumir de una API REST MEAN</p>
</li>
<li>
<p>Usar JSON Web Tokens (JWT) como control de acceso a la API</p>
</li>
<li>
<p>Usar Swagger para la documentación de la API</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueconfiguraci-n-del-entorno-para-ubuntu-linux"><a class="anchor" href="#trueconfiguraci-n-del-entorno-para-ubuntu-linux"></a>1. Configuración del entorno para Ubuntu Linux</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para el desarrollo de este tutorial necesitaremos configurar un entorno con <a href="https://www.mongodb.com/what-is-mongodb">MongoDB</a> (un gestor de bases de datos de documentos), <a href="https://nodejs.org/es/">Node.js</a> (un entorno de ejecución JavaScript) y <a href="https://expressjs.com/es/">Express</a> (un framework de Node.js para desarrollo web muy útil en la creación de APIs REST).</p>
</div>
<div class="paragraph">
<p>También usaremos <a href="https://nodemon.io/">nodemon</a>, una utilidad que recarga el servidor Node.js ante cualquier cambio en el código del proyecto.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash"># Installing MongoDB
$ sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 9DA31620334BD75D9DCB49F368818C72E52529D4
$ sudo echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/4.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.0.list
$ sudo apt-get update
$ sudo apt-get install -y mongodb-org
$ sudo service mongod start

# Installing Node
$ sudo curl -sL https://deb.nodesource.com/setup_10.x | sudo -E bash -
$ apt-get install -y nodejs

# Installing Express
$ npm install -g express-generator

# Installing nodemon
$ npm install -g nodemon</code></pre>
</div>
</div>
<div class="paragraph">
<p>Comprobaremos el funcionamiento correcto desde una terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ node --version
v10.15.3
$ npm --version
6.4.1
$ express --version
4.16.0</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truepreparaci-n-del-proyecto"><a class="anchor" href="#truepreparaci-n-del-proyecto"></a>2. Preparación del proyecto</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nuestro proyecto tratará sobre la creación de una API REST sencilla para la gestión de libros. Implementaremos los métodos CRUD básicos. Cada libro tendrá un título, género, descripción, autor, editorial, número de páginas, y URL de la imagen del libro.</p>
</div>
<div class="sect2">
<h3 id="truecreaci-n-del-proyecto"><a class="anchor" href="#truecreaci-n-del-proyecto"></a>2.1. Creación del proyecto</h3>
<div class="paragraph">
<p>Para el desarrollo del proyecto usaremos <a href="https://mongoosejs.com/">Mongoose</a>, un ODM que facilita el desarrollo de aplicaciones Node.js para MongoDB. Entre otras características, Mongoose introduce esquemas para las colecciones MongoDB permitiendo el modelado de datos de la aplicación, así como la validación de tipos.</p>
</div>
<div class="paragraph">
<p>Comenzaremos creando un directorio para nuestro proyecto, inicializando un proyecto Express, instalando todas las dependencias del proyecto e instalando Mongoose en nuestro proyecto para la interacción con MongoDB.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ mkdir bookstore
$ cd bookstore
$ express
$ npm install
$ npm install mongoose --save</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueestructura-predeterminada-del-proyecto"><a class="anchor" href="#trueestructura-predeterminada-del-proyecto"></a>2.2. Estructura predeterminada del proyecto</h3>
<div class="paragraph">
<p>Tras inicializar el proyecto con Express, la estructura del proyecto es similar a la que se describe a continuación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">├── app.js <i class="conum" data-value="1"></i><b>(1)</b>
├── bin
│   └── www
├── node_modules <i class="conum" data-value="2"></i><b>(2)</b>
│   ├── ...
├── package.json <i class="conum" data-value="3"></i><b>(3)</b>
├── public <i class="conum" data-value="4"></i><b>(4)</b>
│   ├── images
│   ├── javascripts
│   └── stylesheets
├── routes <i class="conum" data-value="5"></i><b>(5)</b>
│   ├── index.js
│   └── users.js
└── views <i class="conum" data-value="6"></i><b>(6)</b>
    ├── error.jade
    ├── index.jade
    └── layout.jade</code></pre>
</div>
</div>
<div class="paragraph">
<p>Destacamos lo siguiente:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>En el archivo <code>app.js</code> se definen, entre otros, los archivos de rutas (p.e. archivos de rutas de la aplicación y de la API), el motor de plantilla usado (p.e. <a href="http://jade-lang.com/">Jade</a>) y la ubicación de la carpeta de vistas.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>El directorio <code>node_modules</code> contiene los módulos instalados de la aplicación.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>El archivo <code>package.json</code> contiene información descriptiva de la aplicación, punto de inicio (p.e. <code>bin/www</code>) y dependencias (p.e. Express, Jade, Mongoose, &#8230;&#8203;)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>En el directorio <code>public</code> colocaremos las imágenes, hojas de estilo y scripts que no queremos que bloqueen al servidor mientras son servidos a los clientes.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>El directorio <code>routes</code> contiene archivos de rutas que indican los controladores que dan respuesta a cada petición</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>El directorio <code>views</code> contiene cada una de las vistas de presentación de datos de la aplicación.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueconfiguraci-n-de-carpetas"><a class="anchor" href="#trueconfiguraci-n-de-carpetas"></a>2.3. Configuración de carpetas</h3>
<div class="paragraph">
<p>Express crea de forma predeterminada la estructura anterior. Sin embargo, de cara a desarollar la API es conveniente crear una carpeta aparte que incluya los modelos, rutas y controladores asociados. Esta es la organzación propuesta:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">api_server/
├── controllers
├── models
└── routes</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para crearla, ejecutaríamos estos comandos desde la carpeta del proyecto</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ mkdir -p api_server/models
$ mkdir -p api_server/controllers
$ mkdir -p api_server/routes</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueinicializar-la-base-de-datos"><a class="anchor" href="#trueinicializar-la-base-de-datos"></a>2.4. Inicializar la base de datos</h3>
<div class="paragraph">
<p>De cara a poder trabajar en la API, desde la shell de MongoDB inicializaremos una base de datos de ejemplo que incluya una colección con al menos un documento para poder hacer las pruebas con operaciones <code>GET</code>. La base de datos se denomina <code>bookstore</code> y la colección <code>books</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">mongo&gt; create database bookstore;
mongo&gt; use bookstore;
mongo&gt; db.books.insert(
{
	"_id" : ObjectId("5abe944733599b27439db885"),
	"title" : "Harry Potter y la piedra filosofal",
	"genre" : "Acción y aventura",
	"description" : "Harry vive con sus horribles tíos y el insoportable primo Dudley, hasta que su ingreso en el Colegio Hogwarts de Magia y Hechicería cambia su vida para siempre. Allí aprenderá trucos y encantamientos fabulosos, y hará un puñado de buenos amigos... aunque también algunos temibles enemigos.",
	"author" : "J.K. Rowling",
	"publisher" : "Salamandra",
	"pages" : 256,
	"image_url" : "https://images-na.ssl-images-amazon.com/images/I/51lEw8wGCPL._SX312_BO1,204,203,200_.jpg"
}
);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueconexi-n-y-l-gica-de-conexi-n-desconexi-n"><a class="anchor" href="#trueconexi-n-y-l-gica-de-conexi-n-desconexi-n"></a>2.5. Conexión y lógica de conexión/desconexión</h3>
<div class="listingblock">
<div class="title">Archivo <code>api_server/models/db.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">var mongoose = require('mongoose'); <i class="conum" data-value="1"></i><b>(1)</b>

var dbURI = 'mongodb://localhost/bookstore'; <i class="conum" data-value="2"></i><b>(2)</b>
mongoose.connect(dbURI); <i class="conum" data-value="3"></i><b>(3)</b>

// CONNECTION EVENTS
mongoose.connection.on('connected', function() {
    console.log('Mongoose connected to ' + dbURI);
});
mongoose.connection.on('error', function(err) {
    console.log('Mongoose connection error: ' + err);
});
mongoose.connection.on('disconnected', function() {
    console.log('Mongoose disconnected');
});

// CAPTURE APP TERMINATION / RESTART EVENTS
// To be called when process is restarted or terminated
gracefulShutdown = function(msg, callback) {
    mongoose.connection.close(function() {
        console.log('Mongoose disconnected through ' + msg);
        callback();
    });
};
// For nodemon restarts
process.once('SIGUSR2', function() {
    gracefulShutdown('nodemon restart', function() {
        process.kill(process.pid, 'SIGUSR2');
    });
});
// For app termination
process.on('SIGINT', function() {
    gracefulShutdown('app termination', function() {
        process.exit(0);
    });
});

// BRING IN YOUR SCHEMAS &amp; MODELS
// require('./yourmodel'); <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uso de Mongoose</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inicialización de la URI de la base de datos <code>bookstore</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Conexión a la base de datos</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Más adelante incluiremos aquí los modelos conforme los vayamos creando</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueincluir-el-archivo-code-db-js-code-en-code-app-js-code"><a class="anchor" href="#trueincluir-el-archivo-code-db-js-code-en-code-app-js-code"></a>2.6. Incluir el archivo <code>db.js</code> en <code>app.js</code></h3>
<div class="listingblock">
<div class="title">Fragmento del archivo <code>app.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">...
var createError = require('http-errors');
var express = require('express');
...
require('./api_server/models/db'); <i class="conum" data-value="1"></i><b>(1)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Conectar a la base de datos y cargar los modelos</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si lanzamos la aplicación desde la terminal con <code>nodemon</code> sobre la carpeta del proyecto obtenderemos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">Mongoose connected to mongodb://localhost/bookstore</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecreaci-n-del-primer-endpoint"><a class="anchor" href="#truecreaci-n-del-primer-endpoint"></a>3. Creación del primer endpoint</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="truecreaci-n-del-modelo"><a class="anchor" href="#truecreaci-n-del-modelo"></a>3.1. Creación del modelo</h3>
<div class="paragraph">
<p>En Mongoose todo comienza con un esquema. De acuerdo con la <a href="https://mongoosejs.com/docs/guide.html">documentación de Mongoose</a>, cada esquema se corresponde con una colección MongoDB y define la estructura de los documentos en la colección. En cada esquema definimos los campos, con sus tipos y restricciones.</p>
</div>
<div class="paragraph">
<p>Una vez creada la definición del esquema, se convierte a un <em>modelo</em>, que es con el que se trabajará desde la aplicación. Los modelos se crean pasando el nombre que tendrá el modelo y el nombre del esquema a partir del que se crean.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">mongoose.model(modelName, schema)</code></pre>
</div>
</div>
<div class="paragraph">
<p>A continuación se muestra el modelo para los libros de la aplicación de ejemplo.</p>
</div>
<div class="listingblock">
<div class="title">El archivo <code>api_server/models/book.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">var mongoose = require('mongoose');

var bookSchema = mongoose.Schema({ <i class="conum" data-value="1"></i><b>(1)</b>
    title: {
        type: String,
        required: true
    },
    genre: {
        type: String,
        required: true
    },
    description: {
        type: String
    },
    author: {
        type: String,
        required: true
    },
    publisher: {
        type: String
    },
    pages: {
        type: Number
    },
    image_url: {
        type: String
    }
});

mongoose.model('Book', bookSchema); <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creación del esquema</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creación del modelo <code>Book</code> a partir del esquema <code>bookSchema</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Una vez definido el modelo, lo incluiremos al final del archivo <code>db.js</code></p>
</div>
<div class="listingblock">
<div class="title">Carga del modelo en el archivo <code>api_server/models/db.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">...
require('./book');</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecreaci-n-de-un-controlador-b-sico"><a class="anchor" href="#truecreaci-n-de-un-controlador-b-sico"></a>3.2. Creación de un controlador básico</h3>
<div class="paragraph">
<p>Nuestra API deberá ofrecer una serie de endpoints con cada una de las operaciones permitidas. Cada endpoint será resuelto por su propio controlador.</p>
</div>
<div class="paragraph">
<p>Para ver cómo funciona esto, comenzaremos creando un controlador para una operación sencilla de recuperación de un libro cualquiera sin entrar todavía en el paso de parámetros.</p>
</div>
<div class="listingblock">
<div class="title">Primer controlador en el archivo <code>api_server/controllers/book.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">var mongoose = require('mongoose'); <i class="conum" data-value="1"></i><b>(1)</b>
var Book = mongoose.model('Book'); <i class="conum" data-value="2"></i><b>(2)</b>

module.exports.bookFindOne = function(req, res) { <i class="conum" data-value="3"></i><b>(3)</b>
    Book <i class="conum" data-value="4"></i><b>(4)</b>
    .findOne() <i class="conum" data-value="5"></i><b>(5)</b>
    .exec( <i class="conum" data-value="6"></i><b>(6)</b>
        function(err, book) { <i class="conum" data-value="7"></i><b>(7)</b>
            return res <i class="conum" data-value="8"></i><b>(8)</b>
            .status(200)
            .send(book);
        });
    };</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Objeto Mongoose para interactuar con MongoDB</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Modelo que se corresponde con la colección <code>books</code> de MongoDB</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Controlador implementado mediante la función asíncrona <code>bookFindOne</code>. El controlador recibe la petición en <code>req</code> y devolverá el resultado en <code>res</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Uso del modelo</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Llamada a la función <code>findOne</code> de Mongoose, que se corresponde con la función <code>findOne</code> de MongoDB</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Ejecución de la consulta y paso del resultado a una función asíncrona</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Función asíncrona que se ejecuta tras la consulta y que devuelve los resultados. El objeto <code>err</code> será el objeto en el que se deuelva el error en caso de que se produzca. Si todo funciona correctamente, el resultado se pasa a <code>book</code></td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Se devuelve el resultado <code>book</code> con el estado 200 en el objeto <code>res</code> del controlador</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Un controlador más elaborado contendría un control de errores mínimo como el que se muestra a continuación</p>
</div>
<div class="listingblock">
<div class="title">Añadiendo control de errores al controlador en el archivo <code>api_server/controllers/book.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">var mongoose = require('mongoose');
var Book = mongoose.model('Book');

var sendJSONresponse = function(res, status, content) {
  res.status(status);
  res.json(content);
};

module.exports.bookFindOne = function(req, res) {
  console.log('Finding book details', req.params);
  Book
  .findOne()
  .exec(function(err, book) {
    if (!book) {
      sendJSONresponse(res, 404, {
        "message": "book not found"
      });
      return;
    } else if (err) {
      console.log(err);
      sendJSONresponse(res, 404, err);
      return;
    }
    console.log(book);
    sendJSONresponse(res, 200, book);
  });
};</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecreaci-n-de-la-ruta"><a class="anchor" href="#truecreaci-n-de-la-ruta"></a>3.3. Creación de la ruta</h3>
<div class="paragraph">
<p>Tras crear el controlador procedemos a conectarlo a una ruta. De esta forma al usar esa ruta con un método HTTP concreto se desencadenará la ejecución del controlador.</p>
</div>
<div class="listingblock">
<div class="title">El archivo <code>api_server/routes/index.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">var express = require('express');
var router = express.Router();
var ctrlBook = require('../controllers/book'); <i class="conum" data-value="1"></i><b>(1)</b>

router.get('/', ctrlBook.bookFindOne); <i class="conum" data-value="2"></i><b>(2)</b>

module.exports = router;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Archivo con el código del controlador</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Asociar la ejecución del controlador <code>bookFindOne</code> a una llamada <code>GET</code> a la raíz</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueincoporaci-n-del-archivo-de-rutas-en-code-app-js-code"><a class="anchor" href="#trueincoporaci-n-del-archivo-de-rutas-en-code-app-js-code"></a>3.4. Incoporación del archivo de rutas en <code>app.js</code></h3>
<div class="paragraph">
<p>Una vez creado el archivo de rutas para la API, lo cargaremos en <code>app.js</code>, ya que el archivo de rutas predeterminado es para la aplicación Jade que crea al inicializarse el proyecto Express.</p>
</div>
<div class="listingblock">
<div class="title">Incoporación del archivo de rutas a <code>app.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">...
var apiRouter = require('./api_server/routes/index'); <i class="conum" data-value="1"></i><b>(1)</b>
...
app.use('/api', apiRouter); <i class="conum" data-value="2"></i><b>(2)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Archivo que contiene las rutas a atender y las funciones que las gestionarán</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Ruta en la que se atenderán las llamadas a la API</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El endpoint se puede probar en</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">localhost:3000/api</code></pre>
</div>
</div>
<div class="paragraph">
<p>y devolverá un libro almacenado.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Una vez creado el primer endpoint, los siguientes se crean de forma más sencilla debido a que ya está creada la infraestrucutra que soporta la API (estructura de directorios, archivo <code>db.js</code> con la lógica de conexión/desconexion a MongoDB, creación de los archivos de rutas y controlador, creación de los esquemas y modelos Mongoose y adaptación del archivo <code>app.js</code> para tratar con la carpeta de la API).</p>
</div>
<div class="paragraph">
<p>El procedimiento a seguir para crear nuevos endpoints será:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Añadir la nueva nueva función del controlador al archivo del controlador</p>
</li>
<li>
<p>Añadir la nueva ruta al archivo de rutas para asociar el nuevo enpoint con la función creada en el controlador</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecreaci-n-de-otros-endpoints-de-consulta-get"><a class="anchor" href="#truecreaci-n-de-otros-endpoints-de-consulta-get"></a>4. Creación de otros endpoints de consulta (GET)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Los parámetros se pasan en la ruta precedidos de dos puntos y se reciben en el controlador con el nombre del parámetro sin los dos puntos en <code>req.param.nombre-del-parametro</code>.</p>
</div>
<div class="sect2">
<h3 id="trueobtener-libros-por-id"><a class="anchor" href="#trueobtener-libros-por-id"></a>4.1. Obtener libros por ID</h3>
<div class="sect3">
<h4 id="truecreaci-n-de-la-funci-n-en-el-controlador"><a class="anchor" href="#truecreaci-n-de-la-funci-n-en-el-controlador"></a>4.1.1. Creación de la función en el controlador</h4>
<div class="listingblock">
<div class="title">Fragmento del archivo <code>api_server/controllers/book.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">....
module.exports.bookFindById = function(req, res) {
    if (req.params &amp;&amp; req.params.id) { <i class="conum" data-value="1"></i><b>(1)</b>
        Book
        .findById(req.params.id) <i class="conum" data-value="2"></i><b>(2)</b>
        .exec(
            function(err, book) {
                if (!book) { <i class="conum" data-value="3"></i><b>(3)</b>
                    return res
                    .status(404)
                    .send({"message": "book not found"});
                } else if (err) {
                    return res
                    .status(404)
                    .send(err);
                }
                return res <i class="conum" data-value="4"></i><b>(4)</b>
                .status(200)
                .send(book);
            }
        );
    } else {
        return res
        .status(404)
        .send({"message": "No book in the request"});
    }
};</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Accederemos a <code>req.params</code> para saber si se han pasado parámetros y a <code>req.params.id</code> para acceder al parámetro <code>id</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Llamada a la función <code>findById</code> de Mongoose para recuperar un documento por su <em>Id</em></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Comprobamos en la función de callback si se ha devuelto un libro</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Se devuelve el resultado <code>book</code> con el estado 200 en el objeto <code>res</code> del controlador</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truecreaci-n-de-la-ruta-2"><a class="anchor" href="#truecreaci-n-de-la-ruta-2"></a>4.1.2. Creación de la ruta</h4>
<div class="paragraph">
<p>Ahora sólo faltaría añadir la ruta del endpoint en el archivo de rutas asociando la ruta y el método HTTP a la función definida en el archivos del controlador.</p>
</div>
<div class="listingblock">
<div class="title">Fragmento del archivo <code>api_server/routes/index.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">...
router.get('/id/:id', ctrlBook.bookFindById); <i class="conum" data-value="1"></i><b>(1)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Los parámetros se pasan precedidos de dos puntos (<code>:</code>)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El endpoint se puede probar en</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">localhost:3000/api/id/5abe944733599b27439db885</code></pre>
</div>
</div>
<div class="paragraph">
<p>y devolverá el libro solicitado.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueobtener-libros-por-g-nero"><a class="anchor" href="#trueobtener-libros-por-g-nero"></a>4.2. Obtener libros por género</h3>
<div class="paragraph">
<p>En este ejemplo veremos la implementación de un endpoint que devuelve una lista de libros. El endpoint tomará el género como parámetro.</p>
</div>
<div class="sect3">
<h4 id="truecreaci-n-del-controlador"><a class="anchor" href="#truecreaci-n-del-controlador"></a>4.2.1. Creación del controlador</h4>
<div class="listingblock">
<div class="title">Fragmento del archivo <code>api_server/models/book.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">...
module.exports.bookFindByGenre = function(req, res) {
    if (req.params &amp;&amp; req.params.genre) { <i class="conum" data-value="1"></i><b>(1)</b>
        Book
        .find({genre: req.params.genre}) <i class="conum" data-value="2"></i><b>(2)</b>
        .exec(
            function(err, books) {
                if (!books) { <i class="conum" data-value="3"></i><b>(3)</b>
                    return res
                    .status(404)
                    .send({"message": "genre not found"});
                } else if (err) {
                    return res
                    .status(404)
                    .send(err);
                }
                return res <i class="conum" data-value="4"></i><b>(4)</b>
                .status(200)
                .send(books);
            }
        );
    } else {
        return res
        .status(404)
        .send({"message": "No `genre` in request"});
    }
};
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Accederemos a <code>req.params</code> para saber si se han pasado parámetros y a <code>req.params.genre</code> para acceder al parámetro <code>genre</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Llamada a la función <code>find</code> de Mongoose, que se corresponde con la función <code>find</code> de Mongo, y se le pasarán las condiciones de la consulta en forma de documento JSON, al igual que en MongoDB</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Comprobamos en la función de callback si se han devuelto libros</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Se devuelve el resultado <code>books</code> con el estado 200 en el objeto <code>res</code> del controlador</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truecreaci-n-de-la-ruta-3"><a class="anchor" href="#truecreaci-n-de-la-ruta-3"></a>4.2.2. Creación de la ruta</h4>
<div class="paragraph">
<p>Ahora sólo faltaría añadir la ruta del endpoint en el archivo de rutas asociando la ruta y el método HTTP a la función definida en el archivos del controlador.</p>
</div>
<div class="listingblock">
<div class="title">Fragmento del archivo <code>api_server/routes/index.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">...
router.get('/genre/:genre', ctrlBook.bookFindByGenre);
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>El endpoint se puede probar en</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">localhost:3000/api/genre/Historia</code></pre>
</div>
</div>
<div class="paragraph">
<p>y devolverá los libros del género solicitado.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truelas-otras-operaciones-crud"><a class="anchor" href="#truelas-otras-operaciones-crud"></a>5. Las otras operaciones CRUD</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Una vez visto cómo realizar operaciones de recuperación (<code>GET</code>), veremos cómo realizar el resto de operaciones CRUD.</p>
</div>
<div class="paragraph">
<p>Seguiremos el mismo procedimiento anterior, creando primero la función que resuelve el endpoint en el controlador y añadiendo después la ruta del endpoint al archivo de rutas.</p>
</div>
<div class="sect2">
<h3 id="truecreaci-n-de-documentos-post"><a class="anchor" href="#truecreaci-n-de-documentos-post"></a>5.1. Creación de documentos (POST)</h3>
<div class="sect3">
<h4 id="truecreaci-n-del-controlador-2"><a class="anchor" href="#truecreaci-n-del-controlador-2"></a>5.1.1. Creación del controlador</h4>
<div class="paragraph">
<p>Los documentos se crean en Mongoose con el método <code>create</code>. Los parámetros se recogen en <code>req.body.nombre-parametro</code>.</p>
</div>
<div class="paragraph">
<p>Para el envío de parámetros del POST desde Postman añadiremos parejas clave-valor en x-www-form-urlencoded tal y como se ilustra a continuación.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/post-book.png" alt="post book.png">
</div>
</div>
<div class="listingblock">
<div class="title">Fragmento del archivo <code>api_server/controllers/book.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">....
module.exports.bookCreate = function(req, res) {
    Book
    .create({ <i class="conum" data-value="1"></i><b>(1)</b>
        title: req.body.title, <i class="conum" data-value="2"></i><b>(2)</b>
        genre: req.body.genre,
        description: req.body.description,
        author: req.body.author,
        publisher: req.body.publisher,
        pages: req.body.pages,
        image_url: req.body.image_url
    },function(err, book) {
        if (err) { <i class="conum" data-value="3"></i><b>(3)</b>
            return res
            .status(400)
            .send(err);
        }
        return res <i class="conum" data-value="4"></i><b>(4)</b>
        .status(201)
        .send(book);
    });
};
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Llamada a la función <code>create</code> de Mongoose, que creará un documento en MongoDB de acuerdo al esquema definido para la colección</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Los valores a insertar son recogidos en <code>req.body.nombreDelParametro</code> (p.e. <code>req.body.title</code>, <code>req.body.genre</code>, &#8230;&#8203;)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Comprobamos en la función de callback si se ha producido un error al insertar</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Se devuelve el código de estado 200 y el libro creado como resultado</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truecreaci-n-de-la-ruta-4"><a class="anchor" href="#truecreaci-n-de-la-ruta-4"></a>5.1.2. Creación de la ruta</h4>
<div class="paragraph">
<p>Ahora sólo faltaría añadir la ruta del endpoint en el archivo de rutas asociando la ruta y el método POST a la función definida en el archivos del controlador.</p>
</div>
<div class="listingblock">
<div class="title">Fragmento del archivo <code>api_server/routes/index.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">...
router.post('/book', ctrlBook.bookCreate);
...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueeliminaci-n-de-documentos-delete"><a class="anchor" href="#trueeliminaci-n-de-documentos-delete"></a>5.2. Eliminación de documentos (DELETE)</h3>
<div class="paragraph">
<p>La eliminación se realizará pasando el id del documento a eliminar</p>
</div>
<div class="sect3">
<h4 id="truecreaci-n-del-controlador-3"><a class="anchor" href="#truecreaci-n-del-controlador-3"></a>5.2.1. Creación del controlador</h4>
<div class="listingblock">
<div class="title">Fragmento del archivo <code>api_server/controllers/book.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">...
module.exports.bookDelete = function(req, res) {
    if (req.params &amp;&amp; req.params.id) { <i class="conum" data-value="1"></i><b>(1)</b>
        Book
        .findByIdAndDelete(req.params.id) <i class="conum" data-value="2"></i><b>(2)</b>
        .exec(
            function(err, book) {
                if (err) { <i class="conum" data-value="3"></i><b>(3)</b>
                    return res
                    .status(400)
                    .send(err);
                }
                return res <i class="conum" data-value="4"></i><b>(4)</b>
                .status(204)
                .send(null);
            }
        );
    } else {
        return res
        .status(404)
        .send({"message": "No id in the request"});
    }
};
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Accederemos a <code>req.params</code> para saber si se han pasado parámetros y a <code>req.params.id</code> para acceder al parámetro <code>id</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Llamada a la función <code>findByIdAndDelete</code> de Mongoose, inspirada en la función <code>findOneAndDelete</code> de MongoDB, y se le pasará como parámetro el <code>id</code> del libro a borrar</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Comprobamos en la función de callback si se ha producido un error</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Se devuelve el código de estado 204 y <code>null</code> que es el convenio para eliminaciones satisfactorias</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truecreaci-n-de-la-ruta-5"><a class="anchor" href="#truecreaci-n-de-la-ruta-5"></a>5.2.2. Creación de la ruta</h4>
<div class="paragraph">
<p>Ahora sólo faltaría añadir la ruta del endpoint en el archivo de rutas asociando la ruta y el método DELETE a la función definida en el archivos del controlador.</p>
</div>
<div class="listingblock">
<div class="title">Fragmento del archivo <code>api_server/routes/index.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">....
router.delete('/book/:id', ctrlBook.bookDelete);
....</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueactualizaci-n-de-documentos-put"><a class="anchor" href="#trueactualizaci-n-de-documentos-put"></a>5.3. Actualización de documentos (PUT)</h3>
<div class="paragraph">
<p>La actualización se realizará pasando el id del documento a modificar y los campos a actualizar. Se actualizarán sólo los campos pasados en la petición dejando el resto intactos.</p>
</div>
<div class="sect3">
<h4 id="truecreaci-n-del-controlador-4"><a class="anchor" href="#truecreaci-n-del-controlador-4"></a>5.3.1. Creación del controlador</h4>
<div class="listingblock">
<div class="title">Fragmento del archivo <code>api_server/controllers/book.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">...
module.exports.bookUpdate = function(req, res) {
    if (req.params &amp;&amp; req.params.id) { <i class="conum" data-value="1"></i><b>(1)</b>
        Book
        .findById(req.params.id) <i class="conum" data-value="2"></i><b>(2)</b>
        .exec(
            function(err, book) {
                if (!book) { <i class="conum" data-value="3"></i><b>(3)</b>
                    return res
                    .status(404)
                    .send({"message": "no book found"});
                } else {
                    if (req.body.title) { <i class="conum" data-value="4"></i><b>(4)</b>
                        book.title = req.body.title;
                    }
                    if (req.body.genre) {
                        book.genre = req.body.genre;
                    }
                    if (req.body.description) {
                        book.description = req.body.description;
                    }
                    if (req.body.author) {
                        book.author = req.body.author;
                    }
                    if (req.body.publisher) {
                        book.publisher = req.body.publisher;
                    }
                    if (req.body.pages) {
                        book.pages = req.body.pages;
                    }
                    if (req.body.image_url) {
                        book.image_url = req.body.image_url;
                    }
                    book.save(function (err, book) { <i class="conum" data-value="5"></i><b>(5)</b>
                        if (err) { <i class="conum" data-value="6"></i><b>(6)</b>
                            return res
                            .status(404)
                            .send(err);
                        }
                        else {
                            return res <i class="conum" data-value="7"></i><b>(7)</b>
                            .status(200)
                            .send(book);
                        }
                    });
                }
            }
        );
    } else {
        return res
        .status(404)
        .send({"message": "No id in the request"});
    }
};
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Accederemos a <code>req.params</code> para saber si se han pasado parámetros y a <code>req.params.id</code> para acceder al parámetro <code>id</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Llamada a la función <code>findById</code> de Mongoose pasándole el <code>id</code> como argumento</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Comprobamos en la función de callback si se ha encontrado en libro</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Se comprueba si se han pasado valores para cada campo del documento comprobando los parámetros pasados</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Llamada a la función <code>save</code> de Mongoose para almacenar las modificaciones</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Se comprueba si se ha producido algún error</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Se devuelve el estado 200 y el libro modificado, que es el convenio en operaciones de modificación</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truecreaci-n-de-la-ruta-6"><a class="anchor" href="#truecreaci-n-de-la-ruta-6"></a>5.3.2. Creación de la ruta</h4>
<div class="paragraph">
<p>Ahora sólo faltaría añadir la ruta del endpoint en el archivo de rutas asociando la ruta y el método PUT a la función definida en el archivos del controlador.</p>
</div>
<div class="listingblock">
<div class="title">Fragmento del archivo <code>api_server/routes/index.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">...
router.put('/book/:id', ctrlBook.bookUpdate);
...</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueconsumir-de-la-api-rest"><a class="anchor" href="#trueconsumir-de-la-api-rest"></a>6. Consumir de la API REST</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para ilustrar cómo usar la API REST desarrollada anteriormente desarrollaremos un pequeño ejemplo que muestre la lista de libros devueltos por el endpoint <code>localhost:3000/api/books</code></p>
</div>
<div class="paragraph">
<p>De forma predeterminada, la aplicación Express tiene las rutas y las vistas en directorios justo debajo del directorio de la aplicación. Para una mejor organización crearemos un directorio <code>app_server</code> para incluir los directorios de las rutas, controladores y vistas, tal y como se muestra a continuacion.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">app_server/
├── controllers
├── routes
└── views</code></pre>
</div>
</div>
<div class="paragraph">
<p>Podemos crear esa estructura con los comandos siguientes</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ mkdir -p app_server/views
$ mkdir -p app_server/controllers
$ mkdir -p app_server/routes</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="truecreaci-n-del-controlador-5"><a class="anchor" href="#truecreaci-n-del-controlador-5"></a>6.1. Creación del controlador</h3>
<div class="paragraph">
<p>Para hacer uso de la API REST desarrollada anteriormente realizaremos peticiones HTTP a usando un objeto <code>request</code> disponible en el paquete <code>request</code>. Lo instalaremos en nuesro proyecto con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ npm install request --save</code></pre>
</div>
</div>
<div class="paragraph">
<p>Crearemos un controlador denominado <code>books.js</code> para mostrar el listado de libros y estará en la ruta creada <code>app_server/controllers</code></p>
</div>
<div class="listingblock">
<div class="title">El archivo <code>app_server/controllers/books.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">var request = require('request'); <i class="conum" data-value="1"></i><b>(1)</b>
var apiOptions = { <i class="conum" data-value="2"></i><b>(2)</b>
  server: 'http://localhost:3000/api'
};

var renderBooksPage = function(req, res, responseBody) { <i class="conum" data-value="3"></i><b>(3)</b>
  res.render('index', {
    title: 'Express',
    books: responseBody <i class="conum" data-value="4"></i><b>(4)</b>
  });

};

module.exports.bookList = function(req, res, next) { <i class="conum" data-value="5"></i><b>(5)</b>
  var path = '/';
  var requestOptions = { <i class="conum" data-value="6"></i><b>(6)</b>
    url: apiOptions.server + path,
    method: 'GET',
    json: {},
    qs: {}
  };

  request(requestOptions, function(err, response, responseBody) { <i class="conum" data-value="7"></i><b>(7)</b>
    renderBooksPage(req, res, responseBody); <i class="conum" data-value="8"></i><b>(8)</b>
  });
};</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Paquete que ofrece una forma sencilla de realizar operaciones HTTP</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Variable para almacenar la ruta base</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Función de carga de la vista. Se le inyectan los datos que tiene que presentar (título y lista de libros)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Listado de libros a mostrar en la vista</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Controlador para mostrar el listado de libros</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Opciones configuradas que necesita el objeto <code>request</code></td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Llamada a la API y creación de la función asíncrona</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Función que resuelve la presentación de la vista tras recuperar los datos de la API</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truecreaci-n-de-la-ruta-7"><a class="anchor" href="#truecreaci-n-de-la-ruta-7"></a>6.2. Creación de la ruta</h3>
<div class="paragraph">
<p>Crearemos un archivo de rutas denominado <code>index.js</code> que contendrá todas las rutas que atienda la aplicación y estará en el directorio creado <code>app_server/routes</code></p>
</div>
<div class="listingblock">
<div class="title">El archivo <code>app_server/routes/index.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">var express = require('express');
var router = express.Router();
var ctrlBooks = require('../controllers/books'); <i class="conum" data-value="1"></i><b>(1)</b>

/* GET home page. */
router.get('/', ctrlBooks.bookList); <i class="conum" data-value="2"></i><b>(2)</b>

module.exports = router;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Archivo de controladores</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Asociación de ruta a controlador</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truecreaci-n-de-la-vista"><a class="anchor" href="#truecreaci-n-de-la-vista"></a>6.3. Creación de la vista</h3>
<div class="paragraph">
<p>Crearemos un archivo para la vista raíz denominado <code>index.js</code> que presentará el listado de libros y estará en el directorio creado <code>app_server/views</code>. Los datos a mostrar en la vista son inyectados por el controlador.</p>
</div>
<div class="listingblock">
<div class="title">El archivo <code>app_server/views/index.jade</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-jade" data-lang="jade">extends layout

block content
  h1= title
  p Welcome to #{title} <i class="conum" data-value="1"></i><b>(1)</b>
  each book in books <i class="conum" data-value="2"></i><b>(2)</b>
    p= book.title <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Título capturando el título proporcionado por el controlador</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Bucle para recorrer la lista de libros inyectados por el controlador</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Titulo del libro</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truemodificaci-n-del-archivo-code-app-js-code"><a class="anchor" href="#truemodificaci-n-del-archivo-code-app-js-code"></a>6.4. Modificación del archivo <code>app.js</code></h3>
<div class="paragraph">
<p>Dado que las vistas y los controladores ahora se encuentran dentro de la carpeta <code>app_server</code>, es necesario indicar este cambio en el archivo <code>app.js</code></p>
</div>
<div class="listingblock">
<div class="title">Fragmento del archivo <code>app.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">...
var indexRouter = require('./app_server/routes/index'); <i class="conum" data-value="1"></i><b>(1)</b>
...
app.set('views', path.join(__dirname, 'app_server', 'views')); <i class="conum" data-value="2"></i><b>(2)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Incluir <code>app_server</code> en el patch de las rutas</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Incluir <code>app_server</code> en la ruta de las vistas</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueacceso-a-la-api-mediante-json-web-tokens-jwt"><a class="anchor" href="#trueacceso-a-la-api-mediante-json-web-tokens-jwt"></a>7. Acceso a la API mediante JSON Web Tokens (JWT)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Node.js y Express no mantienen información sobre la sesión de cada usuario en el servidor. Además, en aplicaciones SPA el código es entregado al cliente al iniciar la aplicación y después no hay posibilidad de interactuar con el servidor para manejar los datos de las sesiones. Por tanto, el enfoque tradicional para la autenticación no es válido en aplicaciones MEAN. La solución a este problema pasa por almacenar cierta información sobre la sesión en el navegador de forma que sea la propia aplicación la que decide lo que se puede mostrar o no a cada usuario. Una forma de guardar estos datos en el cliente es mediante JSON Web Token (<a href="https://jwt.io/introduction/">JWT</a>)</p>
</div>
<div class="paragraph">
<p>JWT ofrece una forma de asegurar el acceso en una aplicación. Se trata de un objeto JSON cifrado en una cadena que puede ser decodificado por la aplicación y el servidor.</p>
</div>
<div class="paragraph">
<p>Para el proceso de login, el usuario envía sus credenciales al servidor en las llamadas a la API REST. El servidor valida las credenciales (p.e. usando una base de datos) y devuelve un token al navegador. El navegador almacenará este token para reutilizarlo después. Con este enfoque los datos de las sesiones no se guardan en el servidor; se guardan en el navegador.</p>
</div>
<div class="paragraph">
<p>Las API REST no guardan estado y no saben quién está realizando la llamada. En cada llamada se enviará el token al endpoint a través de un <em>middleware</em>. El middleware decodificará el token y determinará si el usuario está autorizado a realizar esa operación. En caso de estar autorizado se continuará con la llamada a la función que resuelve el endpoint.</p>
</div>
<div class="sect2">
<h3 id="truejwt"><a class="anchor" href="#truejwt"></a>7.1. JWT</h3>
<div class="paragraph">
<p>Un JWT consta de tres cadenas separadas por puntos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cabecera: Objeto JSON con el tipo algoritmo de hashing usado codificado en base64url.</p>
</li>
<li>
<p>Payload: Objeto JSON codificado en base64url con los datos o privilegios, es decir, el cuerpo en sí del token.</p>
</li>
<li>
<p>Firma: Hash codificado en base64url de la cabecera y el payload usando un <em>secreto</em> que sólo conoce el servidor que ha creado el token. La firma permite determinar si el token ha sido creado usando el secreto establecido. Si no se ha creado usando dicho secreto, concluiremos que el token es falso y se rechazará la petición.</p>
</li>
</ul>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Procedimiento de creación de un JWT</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">key           = 'secretkey'
unsignedToken = encodeBase64Url(header) + '.' + encodeBase64Url(payload)
signature     = HMAC-SHA256(key, unsignedToken)

token = encodeBase64Url(header) + '.' + encodeBase64Url(payload) + '.' + encodeBase64Url(signature)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Un token de ejemplo con sus tres partes separadas por puntos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJtdG9ycmVzIiwiaWF0IjoxNTU3MjExNzM5LCJleHAiOjE1NTcyMTE4NTl9.SySZ9rd8iJHUKgsia0pY7YvLTmAkVwJdK-wkQkTJiB8</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueincorporaci-n-de-jwt-a-la-api-rest"><a class="anchor" href="#trueincorporaci-n-de-jwt-a-la-api-rest"></a>7.2. Incorporación de JWT a la API REST</h3>
<div class="paragraph">
<p>A continuación se describen los pasos a seguir para crear una API REST con control de acceso basado en tokens.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Creación de los controladores, si no están creados previamente</p>
</li>
<li>
<p>Instalación de las dependencias (<code>jsonwebtoken</code>)</p>
</li>
<li>
<p>Creación de la clave secreta para firmar los tokens</p>
</li>
<li>
<p>Creación de la función de creación de tokens</p>
</li>
<li>
<p>Creación de las funciones de autenticación (registro y login)</p>
</li>
<li>
<p>Creación del middleware</p>
</li>
<li>
<p>Creación de las rutas incluyendo el middleware</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="truecreaci-n-de-los-controladores"><a class="anchor" href="#truecreaci-n-de-los-controladores"></a>7.2.1. Creación de los controladores</h4>
<div class="paragraph">
<p>Los controladores incluyen las funciones que atienden a las peticiones de la API REST. Estas funciones no tienen en cuenta la autenticación. Las API REST no tienen estado. Del control de acceso se encarga el middleware. Las funciones de los controladores se ejecutarán en función de lo que indique el middleware.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>La creación de los controladores ya estaba finalizada en las secciones <a href="#truecreaci-n-del-primer-endpoint">Creación del primer endpoint</a>, <a href="#truecreaci-n-de-otros-endpoints-de-consulta-get">Creación de otros endpoints de consulta (GET)</a> y <a href="#truelas-otras-operaciones-crud">Las otras operaciones CRUD</a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="trueinstalaci-n-de-los-m-dulos-necesarios"><a class="anchor" href="#trueinstalaci-n-de-los-m-dulos-necesarios"></a>7.2.2. Instalación de los módulos necesarios</h4>
<div class="paragraph">
<p>Existen módulos Node.js para generar JWT, como es <code>jsonwebtoken</code>. Lo instalaremos en nuestro proyecto con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ npm install jsonwebtoken --save</code></pre>
</div>
</div>
<div class="paragraph">
<p>También instalaremos el módulo <code>moment</code> para las operaciones con los tiempos para establecer la caducidad de los tokens.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ npm install moment --save</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truecreaci-n-de-la-clave-secreta"><a class="anchor" href="#truecreaci-n-de-la-clave-secreta"></a>7.2.3. Creación de la clave secreta</h4>
<div class="paragraph">
<p>A continuación crearemos un archivo que contiene la clave secreta de firma de los tokens. Por motivos de seguridad, este archivo será excluido del control de versiones. Primero intentará tomarse el valor para el secreto desde la variable de entorno. Si la variable de entorno no está configurada, se le asignará como valor predeterminado el que se indique en el archivo <code>config.js</code>.</p>
</div>
<div class="listingblock">
<div class="title">El archivo <code>api_server/config.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">module.exports = {
    TOKEN_SECRET: process.env.TOKEN_SECRET || "password"
  };</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truecreaci-n-del-token"><a class="anchor" href="#truecreaci-n-del-token"></a>7.2.4. Creación del token</h4>
<div class="paragraph">
<p>La creación del token se realizará a través de una función que denominaremos <code>createToken</code>. La función construye el <em>payload</em> tomando los valores que queramos incluir en el token. Estos valores se conocen como <em>claims</em>. Existen <em>claims</em> registrados o reservados (p.e. <code>sub</code> para el nombre de usuarios, <code>iat</code> para la fecha de expedición y <code>exp</code> para la fecha de caducidad). También se pueden crear <em>claims</em>  personalizados o privados para intercambiar información a través del token. La función <code>createToken</code> devolverá el token firmado con el secreto configurado anteriormente.</p>
</div>
<div class="listingblock">
<div class="title">El archivo <code>api_server/controllers/service.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">var jwt = require('jsonwebtoken'); <i class="conum" data-value="1"></i><b>(1)</b>
var moment = require('moment'); <i class="conum" data-value="2"></i><b>(2)</b>
var config = require('../config'); <i class="conum" data-value="3"></i><b>(3)</b>

exports.createToken = function(user) { <i class="conum" data-value="4"></i><b>(4)</b>
  var payload = {
    sub: user, <i class="conum" data-value="5"></i><b>(5)</b>
    iat: moment().unix(), <i class="conum" data-value="6"></i><b>(6)</b>
    exp: moment().add(2, "minutes").unix(), <i class="conum" data-value="7"></i><b>(7)</b>
  };
  return jwt.sign(payload, config.TOKEN_SECRET); <i class="conum" data-value="8"></i><b>(8)</b>
};</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uso del módulo <code>jsonwebtoken</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Uso del módulo <code>moment</code> para manipulación de fechas y horas.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Carga del secreto</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>La función de creación del token toma al usuario como argumento en este ejemplo</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Inclusión del usuario en el payload</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Inclusión de la fecha actual</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Configuración de la caducidad del token como 2 minutos despúes de la fecha actual</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Creación del token añadiéndole el secreto</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truem-dulo-de-autenticaci-n"><a class="anchor" href="#truem-dulo-de-autenticaci-n"></a>7.2.5. Módulo de autenticación</h4>
<div class="paragraph">
<p>El módulo de autenticación se encarga de registrar usuarios y comprobar si pueden iniciar sesión (p.e. comprobando si existen en la base de datos de usuarios registrados). Si todo va bien, se devolverá un token que permitirá el acceso a los endpoints privados de la API.</p>
</div>
<div class="listingblock">
<div class="title">El archivo <code>api_server/controllers/auth.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">var mongoose = require('mongoose');
var User = mongoose.model('User');
var service = require('../service'); <i class="conum" data-value="1"></i><b>(1)</b>

module.exports.signup = function(req, res) { <i class="conum" data-value="2"></i><b>(2)</b>
  User
  .create({username: req.body.username, password: req.body.password}, function(err, user) { <i class="conum" data-value="3"></i><b>(3)</b>
    if (err) {
      return res.status(400).send(err); <i class="conum" data-value="4"></i><b>(4)</b>
    }
    return res
    .status(200)
    .send({token: service.createToken(req.body.username)}); <i class="conum" data-value="5"></i><b>(5)</b>
  });
};

module.exports.login = function(req, res) { <i class="conum" data-value="6"></i><b>(6)</b>
  if (req.body.username &amp;&amp; req.body.password) {
    User
    .count({username: req.body.username, password: req.body.password}) <i class="conum" data-value="7"></i><b>(7)</b>
    .exec(function(err, user) {
      if (!user) {
        return res.status(401).send({"message": "Invalid user and/or password"}); <i class="conum" data-value="8"></i><b>(8)</b>
      } else if (err) {
        return res.status(404).send(err); <i class="conum" data-value="9"></i><b>(9)</b>
      }
      return res
      .status(200)
      .send({token: service.createToken(req.body.username)}); <i class="conum" data-value="10"></i><b>(10)</b>
    });
  } else {
    return res.status(401).send({"message": "Invalid user and/or password"}); <i class="conum" data-value="11"></i><b>(11)</b>
  }
};</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Carga del servicio para poder usar la función <code>createToken</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Función de registro de usuarios. Tras un registro satisfactorio devuelve un token de acceso a la API</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creación del usuario en la base de datos</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Devolver un error si no se ha creado con éxito el usuario</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Devolver un token si el usuario se ha creado con éxito</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Función de inicio de sesión.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Consulta que devuelve el número de usuarios con el login y pass proporcionados</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Si no existe nada con esas creadenciales se devuelve un error</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Devolver un error si se produce un error al consultar</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Si existen las credenciales se devuelve un token de acceso a la API</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Devolver error si falta algún parámetro</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truecreaci-n-del-middleware"><a class="anchor" href="#truecreaci-n-del-middleware"></a>7.2.6. Creación del middleware</h4>
<div class="paragraph">
<p>A continuación tenemos que crear el <em>middleware</em>. Su función es la de actuar como una fase intermedia entre la petición y su resolución. El objetivo del middleware es el de determinar si se trata de una petición autorizada.</p>
</div>
<div class="paragraph">
<p>La función <code>ensureAuthenticated</code> pasará la ejecución a la etapa siguiente (la resolución de la llamada al endpoint) si se cumplen todas estas condiciones:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>La petición incluye una autorización en la cabecera</p>
</li>
<li>
<p>La signatura incluye el secreto concertado</p>
</li>
<li>
<p>El token no está caducado</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">El archivo <code>api_server/controllers/middleware.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">var jwt = require('jsonwebtoken'); <i class="conum" data-value="1"></i><b>(1)</b>
var moment = require('moment');
var config = require('../config');

exports.ensureAuthenticated = function(req, res, next) {
  if(!req.headers.authorization) { <i class="conum" data-value="2"></i><b>(2)</b>
    return res
    .status(403)
    .send({message: "Petición sin cabecera de autorización"});
  }

  var token = req.headers.authorization.split(" ")[1]; <i class="conum" data-value="3"></i><b>(3)</b>
  var payload = jwt.verify(token, config.TOKEN_SECRET, function(err, payload) {
    if (err) {
      switch (err.name) { <i class="conum" data-value="4"></i><b>(4)</b>
        case 'JsonWebTokenError':
          return res.status(401).send({message: "Signatura incorrecta"});
        case 'TokenExpiredError':
          return res.status(401).send({message: "Token caducado"});
        default:
          return res.status(401).send(err);
      }
    }
    req.user = payload.sub; <i class="conum" data-value="5"></i><b>(5)</b>
    next(); <i class="conum" data-value="6"></i><b>(6)</b>
  });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uso del módulo <code>jsonwebtoken</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Comprobación de la existencia de autorización en la cabecera</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Obtención del token incluido en la cabecera</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Comprobación de la existencia de errores</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Carga de datos del payload desde el middleware para pasarlos a la etapa siguiente</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Paso a la etapa siguiente</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truecreaci-n-de-las-rutas"><a class="anchor" href="#truecreaci-n-de-las-rutas"></a>7.2.7. Creación de las rutas</h4>
<div class="paragraph">
<p>El archivo de rutas indica cómo resolver cada una de las peticiones, tanto de login/registro, como de los endpoints en sí de la API. Para una mayor modularidad, el código de los controladores estará fuera del archivo de rutas.</p>
</div>
<div class="listingblock">
<div class="title">El archivo <code>routes/index.js</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">var express = require('express');
var router = express.Router();

var middleware = require('../controllers/middleware'); <i class="conum" data-value="1"></i><b>(1)</b>
var ctrlAuth = require('../controllers/auth'); <i class="conum" data-value="2"></i><b>(2)</b>
var ctrlBook = require('../controllers/book'); <i class="conum" data-value="3"></i><b>(3)</b>

router.get('/', middleware.ensureAuthenticated, ctrlBook.bookList); <i class="conum" data-value="4"></i><b>(4)</b>
router.get('/book/:id', middleware.ensureAuthenticated, ctrlBook.bookFindById);
router.get('/genre/:genre', middleware.ensureAuthenticated, ctrlBook.bookFindByGenre);

router.post('/book', middleware.ensureAuthenticated, ctrlBook.bookCreate);
router.delete('/book/:id', middleware.ensureAuthenticated, ctrlBook.bookDelete);
router.put('/book/:id', middleware.ensureAuthenticated, ctrlBook.bookUpdate);

// Rutas de registro y login
router.post('/auth/signup', ctrlAuth.emailSignup); <i class="conum" data-value="5"></i><b>(5)</b>
router.post('/auth/login', ctrlAuth.emailLogin);

module.exports = router;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Carga del middleware para comprobar si se permite el acceso</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Carga del controlador de registro y login</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Carga del controlador de libros</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Llamada a controladores condicionada al resultado de la evaluación (comprobación de token) del middleware</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Rutas de registro y login</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueuso-de-la-api-mediante-autenticaci-n"><a class="anchor" href="#trueuso-de-la-api-mediante-autenticaci-n"></a>7.3. Uso de la API mediante autenticación</h3>
<div class="paragraph">
<p>Veamos el funcionamiento de la API ante las diversas situaciones que se pueden presentar:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Si intentamos acceder sin cabecera al endpoint privado (<code>localhost:3000/api</code>) devuelve el código de error <code>403 Forbidden</code> con el siguiente contenido:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">{
    "message": "Petición sin cabecera de autorización"
}</code></pre>
</div>
</div>
</li>
<li>
<p>Si nos registramos pasando el <code>username</code> y <code>password</code> (<code>localhost:3000/api/auth/signup</code>) devuelve el código de estado <code>200 OK</code> con el token:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">{
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJtdG9ycmVzIiwiaWF0IjoxNTU3MjExNzM5LCJleHAiOjE1NTcyMTE4NTl9.SySZ9rd8iJHUKgsia0pY7YvLTmAkVwJdK-wkQkTJiB8"
}</code></pre>
</div>
</div>
</li>
<li>
<p>Si iniciamos sesión (<code>localhost:3000/api/auth/login</code>) pasando los datos de login (<code>username</code> y <code>password</code>), se devuelve el código de estado <code>200 OK</code> con el token:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">{
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJtdG9ycmVzIiwiaWF0IjoxNTU3MjExODA1LCJleHAiOjE1NTcyMTE5MjV9.28a8e5y8uYFuo_t7pNuGVzP1qsl4iyAQ_v2503RYC-8"
}</code></pre>
</div>
</div>
</li>
<li>
<p>Si accedemos a un endpoint privado (p.e. <code>localhost:3000/api</code>) con el token antes de que caduque, se devuelve el código de estado <code>200 OK</code> con el resultado de la petición</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El token lo pasaremos como <a href="https://swagger.io/docs/specification/authentication/bearer-authentication/"><em>Bearer Token</em></a> en el desplegable <em>Tipo</em> de la pestaña <em>Autorización</em> de Postman</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Si intentamos acceder a un endpoint privado (p.e. <code>localhost:3000/api</code>) una vez caducado el token (el token del ejemplo caduca a los 2 minutos), se devuelve el código de error <code>401 Unauthorized</code> con el siguiente contenido:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">{
    "message": "Token caducado"
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truedocumentaci-n-de-la-api-mediante-swagger"><a class="anchor" href="#truedocumentaci-n-de-la-api-mediante-swagger"></a>8. Documentación de la API mediante Swagger</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://swagger.io/">Swagger</a> es un framework que ofrece un conjunto de herramientas para la creación y documentación de APIs REST. Podemos optar por usar Swagger desde cero para crear la especificación de la API y Swagger nos asistirá en la generación de la documentación y del código de la API, así como de otras tareas de <em>testing</em> para comprobar, por ejemplo, si existe código asociado a cada tipo de estado devuelto por cada operación de la API. Otra opción es usar Swagger para documentar una API ya existente. En nuestro caso usaremos esta última opción para documentar la API desarrollada en este tutorial.</p>
</div>
<div class="paragraph">
<p>Para este tutorial usaremos el <a href="https://editor.swagger.io/">editor online de Swagger</a>, aunque hay gran cantidad de <a href="https://swagger.io/tools/">herramientas Swagger</a> online y on-premise que nos asisten en el proceso de creación y documentación de una API.</p>
</div>
<div class="paragraph">
<p>Al usar la <em>live demo</em> del editor online de Swagger ya tendremos un ejemplo de código fuente de la documentación de una API, así como su vista previa. A partir del ejemplo generado, podemos tomarlo como punto de partida y realizar las modificaciones necesarias para crear la documentación de nuestra propia API.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/SwaggerEditor.png" alt="SwaggerEditor.png">
</div>
<div class="title">Figure 1. Editor online de Swagger</div>
</div>
<div class="sect2">
<h3 id="truepartes-b-sicas-de-la-documentaci-n-swagger"><a class="anchor" href="#truepartes-b-sicas-de-la-documentaci-n-swagger"></a>8.1. Partes básicas de la documentación Swagger</h3>
<div class="paragraph">
<p>La documentación de ejemplo generada está creada en <a href="https://en.wikipedia.org/wiki/YAML">YAML</a>. En ella, podemos destacar las secciones siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>swagger</code>: Versión de Swagger que estamos usando. La versión actual es la 2, aunque ya existe una versión 3.</p>
</li>
<li>
<p><code>info</code>: Información general de interés sobre la API (descripción, versión, titulo, términos de servicio, datos de contacto, &#8230;&#8203;)</p>
</li>
<li>
<p><code>host</code>: Se usa para lanzar peticiones de prueba desde la propia documentación y se corresponde con el host donde reside la API.</p>
</li>
<li>
<p><code>tags</code>: Permiten agrupar los endpoints (p.e. <code>books</code>, <code>categories</code>, <code>users</code>, &#8230;&#8203;)</p>
</li>
<li>
<p><code>schemes</code>: Esquemas permitidos (<code>http</code> o <code>https</code>)</p>
</li>
<li>
<p><code>paths</code>: Rutas de la API. Normalmente se agrupan por entidad (p.e. <code>book</code>, <code>author</code>). Dentro de cada entidad estarán las distintas operaciones permitidas (<code>GET</code>, <code>PUT</code>, <code>POST</code>, &#8230;&#8203;)</p>
</li>
<li>
<p><code>securityDefinitions</code>: Permite definir modelos de autenticación para las pruebas de la API que se hagan desde la documentación Swagger de la API.</p>
</li>
<li>
<p><code>definitions</code>: Definición de los modelos de la API</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="truedocumentaci-n-swagger-de-la-api-fragmento"><a class="anchor" href="#truedocumentaci-n-swagger-de-la-api-fragmento"></a>8.2. Documentación Swagger de la API (fragmento)</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml" data-lang="yaml">swagger: '2.0'
info: <i class="conum" data-value="1"></i><b>(1)</b>
  description: |
    API REST de Bookstore
  version: 1.0.0
  title: Bookstore REST API
  termsOfService: http://swagger.io/terms/
  contact:
    email: mtorres@ual.es
  license:
    name: Apache 2.0
    url: http://www.apache.org/licenses/LICENSE-2.0.html
tags: <i class="conum" data-value="2"></i><b>(2)</b>
- name: book
  description: Libros de la tienda online
paths: <i class="conum" data-value="3"></i><b>(3)</b>
  /book/{id}: <i class="conum" data-value="4"></i><b>(4)</b>
    get: <i class="conum" data-value="5"></i><b>(5)</b>
      tags: <i class="conum" data-value="6"></i><b>(6)</b>
      - book
      summary: Obtener libro por id <i class="conum" data-value="7"></i><b>(7)</b>
      operationId: bookFindById <i class="conum" data-value="8"></i><b>(8)</b>
      produces: <i class="conum" data-value="9"></i><b>(9)</b>
      - application/json
      parameters: <i class="conum" data-value="10"></i><b>(10)</b>
      - name: id
        in: path
        description: El id del libro a recuperar. Use 5cac6351f4c126f6d91c6450 para pruebas.
        required: true
        type: string
      responses: <i class="conum" data-value="11"></i><b>(11)</b>
        200:
          description: Operación correcta
          schema:
            $ref: '#/definitions/Book'
        400:
          description: id inválido
        404:
          description: Libro no encontrado
    put: <i class="conum" data-value="12"></i><b>(12)</b>
      tags:
      - book
      summary: Libro actualizado
      description: Esta operación sólo la pueden realizar los usuarios que hayan iniciado sesión.
      operationId: bookUpdate
      produces:
      - application/json
      parameters:
      - name: id
        in: path
        description: id del libro a modificar
        required: true
        type: string
      responses:
        400:
          description: id inválido
        404:
          description: Libro no encontrado
    delete: <i class="conum" data-value="13"></i><b>(13)</b>
      tags:
      - book
      summary: Eliminar usuario
      description: Esta operación sólo la pueden realizar los usuarios que hayan iniciado sesión.
      operationId: bookDelete
      produces:
      - application/json
      parameters:
      - name: id
        in: path
        description: El id del libro a eliminar
        required: true
        type: string
      responses:
        400:
          description: id inválido
        404:
          description: Libro no encontrado
definitions: <i class="conum" data-value="14"></i><b>(14)</b>
  Book:
    type: object
    required:
    - title
    - genre
    - author
    properties:
      title:
        type: string
      genre:
        type: string
      description:
        type: string
      author:
        type: string
      publisher:
        type: string
      pages:
        type: integer
      image_url:
        type: boolean
    xml:
      name: Book
externalDocs: <i class="conum" data-value="15"></i><b>(15)</b>
  description: Más información sobre Swagger
  url: http://swagger.io
host: localhost:3000 <i class="conum" data-value="16"></i><b>(16)</b>
basePath: /api <i class="conum" data-value="17"></i><b>(17)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Información descriptiva</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Tags para organizar los endpoints</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Paths de la API</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Ruta de acceso</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Verbo HTTP del endpoint</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Tag en el que agrupar el endpoint de cara a organizar los endpoints en la documentación</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Descripción del endpoint</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Nombre del método que se encarga de implementar la operación. Util cuando se usa la generáción de código y las funciones de testing</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Tipo de respuesta devuelto</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Parámetros de entrada del endpoint</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Respuestas producidas por el método</td>
</tr>
<tr>
<td><i class="conum" data-value="12"></i><b>12</b></td>
<td>Operación <code>PUT</code></td>
</tr>
<tr>
<td><i class="conum" data-value="13"></i><b>13</b></td>
<td>Operación <code>DELETE</code></td>
</tr>
<tr>
<td><i class="conum" data-value="14"></i><b>14</b></td>
<td>Definición de los modelos</td>
</tr>
<tr>
<td><i class="conum" data-value="15"></i><b>15</b></td>
<td>Documentación complementaria de interés</td>
</tr>
<tr>
<td><i class="conum" data-value="16"></i><b>16</b></td>
<td>Servidor donde está alojada la API</td>
</tr>
<tr>
<td><i class="conum" data-value="17"></i><b>17</b></td>
<td>Path de acceso a la API</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueincorporar-la-documentaci-n-de-la-api-al-proyecto"><a class="anchor" href="#trueincorporar-la-documentaci-n-de-la-api-al-proyecto"></a>8.3. Incorporar la documentación de la API al proyecto</h3>
<div class="paragraph">
<p>Una vez creada la documentación, para pasarla al proyecto usaremos el paquete Node.js <code>swagger-ui-express</code>, que sirve la documentación de Swagger mediante <a href="https://swagger.io/tools/swagger-ui/">Swagger UI</a> en la ruta que definamos en nuestro proyecto. Swagger UI presenta la documentación de la API y permite interactuar con los endpoints.</p>
</div>
<div class="paragraph">
<p>Después exportaremos a un archivo JSON local (normalmente <code>swagger.json</code>) la documentación creada en el editor online de Swagger.</p>
</div>
<div class="paragraph">
<p>Por último, añadiremos el archivo JSON con la documentación al proyecto y modificaremos <code>app.js</code> para incluir el acceso a la documentación.</p>
</div>
<div class="paragraph">
<p>A continuación se describen estos pasos.</p>
</div>
<div class="sect3">
<h4 id="trueinstalaci-n-de-code-swagger-ui-express-code"><a class="anchor" href="#trueinstalaci-n-de-code-swagger-ui-express-code"></a>8.3.1. Instalación de <code>swagger-ui-express</code></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash" data-lang="bash">$ npm install swagger-ui-express --save</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="trueexportar-la-api-a-json"><a class="anchor" href="#trueexportar-la-api-a-json"></a>8.3.2. Exportar la API a JSON</h4>
<div class="paragraph">
<p>Swagger UI usa JSON como formato para la documentación de la API. Para guardar la documentación en formato JSON, en el editor online seleccionaremos <code>File</code> | <code>Convert and save as JSON</code>.</p>
</div>
<div class="paragraph">
<p>El resultado será algo similar a esto:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json" data-lang="json">{
  "swagger" : "2.0",
  "info" : {
    "description" : "API REST de Bookstore\n",
    "version" : "1.0.0",
    "title" : "Bookstore REST API",
    "termsOfService" : "http://swagger.io/terms/",
    "contact" : {
      "email" : "mtorres@ual.es"
    },
    "license" : {
      "name" : "Apache 2.0",
      "url" : "http://www.apache.org/licenses/LICENSE-2.0.html"
    }
  },
...
  "schemes" : [ "https", "http" ],
  "paths" : {
    "/book/{id}" : {
      "get" : {
        "tags" : [ "book" ],
        "summary" : "Obtener libro por id",
        "operationId" : "bookFindById",
        "produces" : [ "application/json" ],
        "parameters" : [ {
          "name" : "id",
          "in" : "path",
          "description" : "El id del libro a recuperar. Use xxx para pruebas.",
          "required" : true,
          "type" : "string"
        } ],
        "responses" : {
          "200" : {
            "description" : "Operación correcta",
            "schema" : {
              "$ref" : "#/definitions/Book"
            }
          },
          "400" : {
            "description" : "id inválido"
          },
          "404" : {
            "description" : "Libro no encontrado"
          }
        }
      },
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Colocaremos este archivo como <code>swagger.json</code> en la carpeta raíz del código del proyecto.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueimportaci-n-de-la-documentaci-n-como-una-ruta-del-proyecto"><a class="anchor" href="#trueimportaci-n-de-la-documentaci-n-como-una-ruta-del-proyecto"></a>8.4. Importación de la documentación como una ruta del proyecto</h3>
<div class="paragraph">
<p>Swagger UI presentará la documentación de la API a través de una ruta de nuestra aplicación. Para ofrecer la documentación de la API a través de Swagger UI incluiremos el código siguiente en <code>app.js</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">var swaggerUi = require('swagger-ui-express'); <i class="conum" data-value="1"></i><b>(1)</b>
swaggerDocument = require('./swagger.json'); <i class="conum" data-value="2"></i><b>(2)</b>
...
app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(swaggerDocument)); <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Uso de <code>swagger-ui-express</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Carga del documento JSON de la documentación</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Creación de la ruta de acceso a la documentación</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ahora la documentación de la API estará accesible desde <code><a href="http://localhost:3000/api-docs" class="bare">http://localhost:3000/api-docs</a></code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/BookstoreSwagger.png" alt="BookstoreSwagger.png">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueconclusiones"><a class="anchor" href="#trueconclusiones"></a>9. Conclusiones</h2>
<div class="sectionbody">
<div class="paragraph">
<p>La mayoría de las aplicaciones de hoy día disponen de una API REST para recuperar o realizar operaciones sobre sus datos. Además, una API REST permite la creación de servicios complementarios a los de la aplicación desde la que ha nacido. Saber crear e interactuar con una API REST hoy día es una habilidad fundamental.</p>
</div>
<div class="paragraph">
<p>En este tutorial se estudia cómo desarollar una API REST con la pila MEAN (MongoDB, Express, Angular y Node.js) usando además Mongoose para la interacción con MongoDB. Hemos tratado un ejemplo práctico de creación de una API desde cero, comenzando con la instalación y preparación del entorno, para continuar con la creación de la estructura del proyecto, creación de modelos y creación de endpoints para operaciones CRUD. También hemos visto cómo consumir datos de la API, para terminar usando JWT como mecanismo de control de acceso y documentando la API con Swagger.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueap-ndice-a-c-digos-de-estado-http-frecuentes"><a class="anchor" href="#trueap-ndice-a-c-digos-de-estado-http-frecuentes"></a>Apéndice A. Códigos de estado HTTP frecuentes</h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. Códigos de estado HTTP más frecuentes</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Status</th>
<th class="tableblock halign-left valign-top">code</th>
<th class="tableblock halign-left valign-top">case</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OK</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A successful GET or PUT request</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">201</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Created</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A successful POST request</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">204</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No content</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A successful DELETE request</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">400</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bad request</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An unsuccessful GET, POST, or PUT request, due to invalid content</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">401</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unauthorized</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Requesting a restricted URL with incorrect credentials</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">403</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Forbidden</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Making a request that isn’t allowed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">404</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not found</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unsuccessful request due to an incorrect parameter in the URL</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">500</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Internal server error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Problem with your server or the database server</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="trueap-ndice-b-base-de-datos-de-ejemplo"><a class="anchor" href="#trueap-ndice-b-base-de-datos-de-ejemplo"></a>Apéndice B. Base de datos de ejemplo</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">mongo&gt; use bookstore;
mongo&gt; db.books.insertMany(
[
    {
        "_id": ObjectId("5cac6351f4c126f6d91c6450"),
        "title": "Una historia de España",
        "genre": "Historia",
        "description": "Un relato ameno, personal, a ratos irónico, pero siempre único, de nuestra accidentada historia a través de los siglos. Una obra concebida por el autor para, en palabras suyas, «divertirme, releer y disfrutar; un pretexto para mirar atrás desde los tiempos remotos hasta el presente, reflexionar un poco sobre ello y contarlo por escrito de una manera poco ortodoxa.",
        "author": "Arturo Pérez-Reverte",
        "publisher": "Alfaguara",
        "pages": 256,
        "image_url": "https://images-na.ssl-images-amazon.com/images/I/41%2B-e981m1L._SX311_BO1,204,203,200_.jpg"
    },
    {
        "_id": ObjectId("5cacf56222ee3f230a725895"),
        "title": "Historia de España contada para escépticos",
        "genre": "Historia",
        "description": "Como escribe el autor, no pretende ser veraz, justa y desapasionada, porque ninguna historia lo es. No está hecha para halagar a reyes y gobernantes, ni pretende halagar a los banqueros, ni a la Conferencia Episcopal, ni al colectivo gay.",
        "author": "Juan Eslava Galán",
        "publisher": "Booket",
        "pages": 592,
        "image_url": "https://images-na.ssl-images-amazon.com/images/I/51IyZ5Mq8YL._SX326_BO1,204,203,200_.jpg",
        "__v": 0
    }
]
);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueap-ndice-c-aplicaci-n-base-creada-por-express"><a class="anchor" href="#trueap-ndice-c-aplicaci-n-base-creada-por-express"></a>Apéndice C. Aplicación base creada por Express</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Al crear la aplicación con Express, se creó una estructura de archivos y directorios y una aplicacion web disponible en el puerto 3000</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Express.png" alt="Express.png">
</div>
<div class="title">Figure 2. Aplicación web inicial creada por Express</div>
</div>
<div class="paragraph">
<p>Esta aplicación web se carga porque en Express define una vista, una ruta y un controlador que se encarga de presentar la vista e inyectarle datos a la vista</p>
</div>
<div class="paragraph">
<p>De forma predeterminada, las vistas de la aplicación inicial se guardan en el directorio <code>views</code> y las rutas en <code>routes</code>. Más adelante veremos como organizar estos directorios en un directorio que contenga los controladores, rutas y vistas de la aplicación.</p>
</div>
<div class="paragraph">
<p>Por ahora basta con saber qué hay en el archivo <code>app.js</code> y cómo se carga la vista inicial de la aplicación.</p>
</div>
<div class="sect2">
<h3 id="trueel-archivo-code-app-js-code"><a class="anchor" href="#trueel-archivo-code-app-js-code"></a>El archivo <code>app.js</code></h3>
<div class="paragraph">
<p>Tras la generación del proyecto con Express se ha configurado la aplicación para que use Jade como motor de plantillas. Además, se indica que las vistas se almacenan en el directorio <code>views</code> del directorio de la aplicación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">....
// view engine setup
app.set('views', path.join(__dirname, 'views')); <i class="conum" data-value="1"></i><b>(1)</b>
app.set('view engine', 'jade'); <i class="conum" data-value="2"></i><b>(2)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Se define como carpeta de vistas la carpeta <code>views</code> sobre el directorio de la aplicación (<code>__dirname</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Jade como motor de plantillas</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Además, en <code>app.js</code> se indica cómo responder a las peticiones que lleguen a la raíz (<code>/</code>). Para ello, se usará un archivo de rutas aparte que contendrá los endpoints relativos a la raíz junto con los controladores que resuelven las peticiones.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">...
var indexRouter = require('./routes/index'); <i class="conum" data-value="1"></i><b>(1)</b>
...
app.use('/', indexRouter); <i class="conum" data-value="2"></i><b>(2)</b>
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ubicación del archivo de rutas</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Uso de las rutas de <code>indexRouter</code> cuando lleguen peticiones a la raíz (<code>/</code>)</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truelas-vistas-iniciales"><a class="anchor" href="#truelas-vistas-iniciales"></a>Las vistas iniciales</h3>
<div class="paragraph">
<p>Inicialmente Express crea 3 vistas en la carpeta <code>views</code> del proyecto:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>layout.jade</code>: Página de base que contiene componentes reutilizados en otras páginas (p.e. la definición de la estructura de documento HTML, la hoja de estilos, y demás).</p>
</li>
<li>
<p><code>index.jade</code>: Página de inicio de la aplicacion</p>
</li>
<li>
<p><code>error.jade</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">El archivo <code>layout.jade</code></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">doctype html
html
  head
    title= title <i class="conum" data-value="1"></i><b>(1)</b>
    link(rel='stylesheet', href='/stylesheets/style.css') <i class="conum" data-value="2"></i><b>(2)</b>
  body
    block content <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>El segundo <code>title</code> es una variable cuyo valor es inyectado por el control y presentado al cargar la vista</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Carga de la hoja de estilos</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define un <em>marcador</em> que será reemplazado posterioremente por otras vistas que extiendan este archivo</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En Jade, el sangrado indica la creación de un subelemento</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">El archivo <code>index.jade</code></div>
<div class="content">
<pre>extends layout <i class="conum" data-value="1"></i><b>(1)</b>

block content <i class="conum" data-value="2"></i><b>(2)</b>
  h1= title <i class="conum" data-value="3"></i><b>(3)</b>
  p Welcome to #{title} <i class="conum" data-value="4"></i><b>(4)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Archivo del que se hereda</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Definición del <em>marcador</em> que reemplazará el bloque en el archivo <code>layout</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Variable cuyo valor será inyectado por el controlador al carga la vista</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Variable cuyo valor será inyectado por el controlador al carga la vista</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truela-ruta-y-el-controlador-inicial"><a class="anchor" href="#truela-ruta-y-el-controlador-inicial"></a>La ruta y el controlador inicial</h3>
<div class="paragraph">
<p>Inicialmente, Express crea una ruta en la raíz y un controlador asociado en el archivo <code>routes/index.js</code> con el código siguiente</p>
</div>
<div class="listingblock">
<div class="title">Fragmento de <code>routes/index.js</code> con la ruta y controlador predeterminado para la raíz</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-js" data-lang="js">...
/* GET home page. */
router.get('/', function(req, res, next) { <i class="conum" data-value="1"></i><b>(1)</b>
  res.render('index', { title: 'Express' }); <i class="conum" data-value="2"></i><b>(2)</b>
});
...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ruta raíz y controlador asociado definido sobre la marcha</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Mostrar la vista <code>index</code> pasándole un JSON con una variable <code>title</code></td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2019-05-08 23:29:31 CEST
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.9.1/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>